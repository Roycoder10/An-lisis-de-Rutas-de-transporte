<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilder Llacchua SAC - App Web</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .text-area-container {
            position: relative;
        }
        textarea:focus + .text-area-placeholder,
        textarea:not(:placeholder-shown) + .text-area-placeholder {
            transform: translateY(0);
            opacity: 1;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-top: 2rem;
        }
        .stop-icon {
            background-color: #e53e3e;
            width: 1.5rem;
            height: 1.5rem;
            display: block;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
            line-height: 1.5rem;
            color: white;
            font-weight: bold;
        }
        .long-stop-icon {
            background-color: #6b46c1;
            width: 2rem;
            height: 2rem;
            display: block;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 2rem;
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }
        .start-icon-custom {
            background-color: #1e40af;
            width: 2rem;
            height: 2rem;
            display: block;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 2rem;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }
        .end-icon-custom {
            background-color: #38a169;
            width: 2rem;
            height: 2rem;
            display: block;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
            line-height: 2rem;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }
        .message-box {
            display: none;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-top: 1.5rem;
            text-align: center;
        }
        .message-box.error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fca5a5;
            display: block;
        }
        /* Clases para el efecto de colapso */
        .collapsible-header {
            cursor: pointer;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease-in-out;
        }
        .collapsible-header:hover {
            background-color: #e2e8f0;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .collapsible-content.expanded {
            max-height: 2000px; /* Valor lo suficientemente grande para contener el contenido */
        }
        .collapsible-icon {
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-black-200">

<div class="container">
    <div class="flex flex-col items-center gap-4 mb-6">
        <img src="https://placehold.co/100x100/1e40af/ffffff?text=R+SAC" alt="Logo de R SAC" class="w-50 h-50 rounded-full shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800">Análisis de Rutas de transporte</h1>
        <p class="text-center text-black-800">Ingresa los datos del GPS</p>
    </div>
    
    <div class="text-area-container mb-4">
        <textarea id="dataInput" rows="10" placeholder="Ejemplo:
31/08/2025 22:10:57 -12.0298916 -77.0427916 RIMAC/LIMA/LIMA 15 km/h
31/08/2025 22:12:05 -12.0299500 -77.0427800 RIMAC/LIMA/LIMA 12 km/h
..." class="w-full p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-y"></textarea>
    </div>

    <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Filtra por rango (opcional)</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="startDateFilter" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
                <input type="date" id="startDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="endDateFilter" class="block text-sm font-medium text-gray-700">Fecha de fin</label>
                <input type="date" id="endDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="startTimeFilter" class="block text-sm font-medium text-gray-700">Hora de inicio</label>
                <input type="time" id="startTimeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="endTimeFilter" class="block text-sm font-medium text-gray-700">Hora de fin</label>
                <input type="time" id="endTimeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
        </div>
    </div>
    
    <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Selecciona Tipo de Vehículo</h3>
        <select id="vehicleType" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            <option value="sedan">Automóvil (Sedán)</option>
            <option value="suv">Camioneta (SUV)</option>
            <option value="truck">Remolcador/Camión (Pesado)</option>
            <option value="bus">Ómnibus (Interurbano)</option>
        </select>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mb-8">
        <button onclick="analyzeData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all text-lg">
            Analizar Datos
        </button>
        <div class="grid grid-cols-2 gap-4 w-full">
            <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">
                Exportar CSV
            </button>
            <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">
                Exportar PDF
            </button>
        </div>
    </div>
    
    <div id="results" class="results-container">
        <div id="message-box" class="message-box">
            <p id="message-text">Mensaje de error.</p>
        </div>
    </div>

    <div id="visualizations-section" class="mt-8">
        <div class="collapsible-header" onclick="toggleSection('summary-content', this)">
            <h2 class="text-xl font-bold text-gray-700">Resumen del Recorrido</h2>
            <svg class="w-6 h-6 text-gray-600 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        <div id="summary-content" class="collapsible-content p-4"></div>
        
        <div class="collapsible-header mt-4" onclick="toggleSection('charts-content', this)">
            <h2 class="text-xl font-bold text-gray-700">Gráficos de Velocidad y Distancia</h2>
            <svg class="w-6 h-6 text-gray-600 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        <div id="charts-content" class="collapsible-content p-4">
            <div class="flex justify-center mb-4">
                <button onclick="resetZoom()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                    Reiniciar Zoom
                </button>
            </div>
            <div class="chart-container">
                <canvas id="speedChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="distanceChart"></canvas>
            </div>
        </div>

        <div class="collapsible-header mt-4" onclick="toggleSection('map-content', this)">
            <h2 class="text-xl font-bold text-gray-700">Ubicación y Mapa de la Ruta</h2>
            <svg class="w-6 h-6 text-gray-600 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        <div id="map-content" class="collapsible-content p-4">
            <div class="mt-8 p-4 bg-gray-100 rounded-lg shadow-inner">
                <h3 class="text-lg font-bold text-gray-700 mb-2">Buscar Ubicación en el Mapa</h3>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="locationSearchInput" placeholder="Ej: Chiclayo, Perú" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                    <button onclick="searchLocation()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                        Buscar
                    </button>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <div class="collapsible-header mt-4" onclick="toggleSection('events-content', this)">
            <h2 class="text-xl font-bold text-gray-700">Detalle de Eventos de Riesgo</h2>
            <svg class="w-6 h-6 text-gray-600 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </div>
        <div id="events-content" class="collapsible-content p-4"></div>
    </div>
    
    <div class="mt-8 p-6 bg-gray-100 rounded-lg shadow-inner">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Instrucciones de Uso</h2>
        <ul class="list-disc pl-6 text-gray-700 space-y-2">
            <li><strong>Ingresar Datos:</strong> Pega los datos de tu GPS en el área de texto. Asegúrate de que cada línea contenga fecha, hora, latitud, longitud, ubicación y velocidad, separados por espacios.</li>
            <li><strong>Analizar Datos:</strong> Haz clic en el botón "Analizar Datos" para visualizar el recorrido en el mapa, ver el resumen de la ruta y los gráficos de velocidad y distancia.</li>
            <li><strong>Filtros:</strong> Usa los filtros de fecha y hora para analizar solo una parte específica de la ruta.</li>
            <li><strong>Exportar:</strong> Los botones "Exportar CSV" y "Exportar PDF" te permiten descargar un resumen de tu análisis para compartir o guardar.</li>
            <li><strong>Buscar Ubicación:</strong> Utiliza el campo de búsqueda para encontrar y centrar el mapa en una ubicación específica.</li>
        </ul>
        
        <h2 class="text-xl font-bold text-gray-800 mt-6 mb-4">Preguntas Frecuentes (FAQ)</h2>
        <ul class="list-disc pl-6 text-gray-700 space-y-2">
            <li><strong>¿Qué es "Análisis de Rutas de transporte"?</strong> Es una herramienta para visualizar y analizar el historial de un vehículo a partir de datos GPS.</li>
            <li><strong>¿Qué datos son compatibles?</strong> El sistema acepta datos en formato: Fecha Hora Latitud Longitud Ubicación Velocidad. Por ejemplo: <code>31/08/2025 22:10:57 -12.0298916 -77.0427916 RIMAC/LIMA/LIMA 15 km/h</code>.</li>
            <li><strong>¿Por qué no funciona?</strong> Asegúrate de que el formato de tus datos sea correcto. Si el problema persiste, revisa los filtros de fecha y hora.</li>
            <li><strong>¿Qué significa la línea roja en el gráfico de velocidad?</strong> Es el límite de velocidad de 95 km/h. Los puntos de la ruta que superen este límite se marcan para ayudarte a identificar riesgos.</li>
            <li><strong>¿Qué es una parada prolongada?</strong> Es una parada que supera los 3 minutos de duración. Se marcan con un ícono morado en el mapa.</li>
        </ul>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/dist/date-fns.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    let mapInstance = null;
    let speedChartInstance = null;
    let distanceChartInstance = null;
    let stopCount = 0;

    const VEHICLE_PERFORMANCE_RATES_KM_PER_GALLON = {
        sedan: 37.85,
        suv: 30.28,
        truck: 11.35,
        bus: 3.33
    };
    const SOLES_PER_GALLON = 9.10;
    const LITERS_PER_GALLON = 3.785;
    const SPEED_LIMIT = 95;
    const LONG_STOP_THRESHOLD = 3;

    function toggleSection(contentId, headerElement) {
        const content = document.getElementById(contentId);
        const icon = headerElement.querySelector('.collapsible-icon');
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            icon.classList.remove('expanded');
        } else {
            content.classList.add('expanded');
            icon.classList.add('expanded');
        }
    }

    function formatTime(minutes) {
        if (minutes < 0) return "0 horas 0 minutos";
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = Math.round(minutes % 60);
        return `${hours} horas ${remainingMinutes} minutos`;
    }

    function formatStopDuration(minutes) {
        if (minutes < 0) return "0 minutos 0 segundos";
        const min = Math.floor(minutes);
        const seconds = Math.round((minutes - min) * 60);
        return `${min} minutos y ${seconds} segundos`;
    }

    function toRadians(degrees) {
        return degrees * Math.PI / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;

        const lat1Rad = toRadians(lat1);
        const lat2Rad = toRadians(lat2);
        const deltaLat = toRadians(lat2 - lat1);
        const deltaLon = toRadians(lon2 - lon1);

        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                  Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                  Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
    }
    
    function calculateFuelAndCost(distance, vehicleType) {
        const kmPerGallon = VEHICLE_PERFORMANCE_RATES_KM_PER_GALLON[vehicleType];
        if (!kmPerGallon || kmPerGallon === 0) return { gallons: 0, cost: 0 };
        
        const gallonsConsumed = distance / kmPerGallon;
        const totalCost = gallonsConsumed * SOLES_PER_GALLON;
        
        return { gallons: gallonsConsumed, cost: totalCost };
    }

    async function searchLocation() {
        const query = document.getElementById('locationSearchInput').value.trim();
        if (!query) {
            const messageText = document.getElementById('message-text');
            const messageBox = document.getElementById('message-box');
            messageText.innerText = 'Por favor, introduce una ubicación para buscar.';
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lon = parseFloat(data[0].lon);
                if (mapInstance) {
                    mapInstance.flyTo([lat, lon], 14);
                }
            } else {
                const messageText = document.getElementById('message-text');
                const messageBox = document.getElementById('message-box');
                messageText.innerText = 'Ubicación no encontrada. Intenta ser más específico (ej: "Chiclayo, Perú").';
                messageBox.style.display = 'block';
                messageBox.classList.add('error');
            }
        } catch (error) {
            console.error('Error al buscar la ubicación:', error);
            const messageText = document.getElementById('message-text');
            const messageBox = document.getElementById('message-box');
            messageText.innerText = 'Ocurrió un error al buscar la ubicación. Por favor, inténtalo de nuevo más tarde.';
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
        }
    }


    function analyzeData() {
        const input = document.getElementById('dataInput').value;
        const startDateFilter = document.getElementById('startDateFilter').value;
        const endDateFilter = document.getElementById('endDateFilter').value;
        const startTimeFilter = document.getElementById('startTimeFilter').value;
        const endTimeFilter = document.getElementById('endTimeFilter').value;
        const vehicleType = document.getElementById('vehicleType').value;
        
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        
        messageBox.style.display = 'none';

        let lines = input.trim().split('\n').filter(line => line.trim() !== '');

        if (lines.length === 0) {
            messageText.innerText = "Por favor, introduce datos en el campo de texto para comenzar el análisis.";
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        const startFilterDateTime = (startDateFilter || startTimeFilter) ? new Date(
            `${startDateFilter || '1970-01-01'}T${startTimeFilter || '00:00:00'}`
        ) : null;
        
        const endFilterDateTime = (endDateFilter || endTimeFilter) ? new Date(
            `${endDateFilter || '2099-12-31'}T${endTimeFilter || '23:59:59'}`
        ) : null;

        if (startFilterDateTime && endFilterDateTime && startFilterDateTime > endFilterDateTime) {
            messageText.innerText = "La fecha y hora de inicio no pueden ser posteriores a la de fin.";
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        const parsedData = [];
        
        lines.forEach((line, index) => {
            try {
                const parts = line.trim().split(/\s+/);
                
                if (parts.length < 6) {
                    console.warn(`Línea ${index + 1}: Formato incorrecto. Se esperan al menos 6 campos. Saltando: "${line}"`);
                    return;
                }

                const date = parts[0];
                const time = parts[1];
                const lat = parseFloat(parts[2]);
                const lon = parseFloat(parts[3]);
                const speed = parseFloat(parts[parts.length - 2]);

                const locationParts = parts.slice(4, parts.length - 2);
                const location = locationParts.join(' ');
                
                if (isNaN(lat) || isNaN(lon) || isNaN(speed)) {
                    console.warn(`Línea ${index + 1}: Los valores de latitud, longitud o velocidad no son números válidos. Saltando: "${line}"`);
                    return;
                }

                const dateParts = date.split('/');
                const timeParts = time.split(':');
                const currentDateTime = new Date(
                    parseInt(dateParts[2], 10),
                    parseInt(dateParts[1], 10) - 1,
                    parseInt(dateParts[0], 10),
                    parseInt(timeParts[0], 10),
                    parseInt(timeParts[1], 10),
                    parseInt(timeParts[2], 10)
                );
                
                if (isNaN(currentDateTime.getTime())) {
                    console.warn(`Línea ${index + 1}: Formato de fecha u hora incorrecto. Saltando: "${line}"`);
                    return;
                }

                const isAfterStart = !startFilterDateTime || currentDateTime.getTime() >= startFilterDateTime.getTime();
                const isBeforeEnd = !endFilterDateTime || currentDateTime.getTime() <= endFilterDateTime.getTime();

                if (isAfterStart && isBeforeEnd) {
                    const dataPoint = { date, time, lat, lon, location, speed, timestamp: currentDateTime.getTime() };
                    parsedData.push(dataPoint);
                }

            } catch(e) {
                console.error(`Línea ${index + 1}: Error inesperado al procesar la línea: "${line}"`, e);
            }
        });

        if (parsedData.length < 2) {
            messageText.innerText = "No se encontraron suficientes puntos de datos válidos para analizar. Por favor, revisa tus datos y los filtros aplicados.";
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        const dataByDate = {};
        let grandTotalDistance = 0;
        let grandTotalOperatingTime = 0;
        let grandTotalStoppedTime = 0;
        let summaryTableContent = '';
        let eventsContent = '';

        const ACCELERATION_THRESHOLD = 20;
        const DECELERATION_THRESHOLD = -20;
        
        const allLatLngs = [];
        const speedData = [];
        const distanceData = [];
        const stops = [];
        let accumulatedDistance = 0;
        
        stopCount = 0;

        parsedData.forEach(point => {
            if (!dataByDate[point.date]) {
                dataByDate[point.date] = [];
            }
            dataByDate[point.date].push(point);
            allLatLngs.push([point.lat, point.lon]);
        });


        for (const date in dataByDate) {
            const dailyData = dataByDate[date];
            dailyData.sort((a, b) => a.timestamp - b.timestamp);

            let totalDistance = 0;
            let totalStoppedTime = 0;
            let totalMovingTime = 0;
            let excessiveSpeedCount = 0;
            let harshAccelerationCount = 0;
            let harshBrakingCount = 0;
            
            let isStopped = false;
            let stopStartTime = null;
            let stopStartLocation = null;
            let stopStartLatLng = null;

            eventsContent += `
                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-2">Eventos detectados el ${date}</h3>
                    <ul class="list-disc pl-6 text-gray-600 mb-4">
            `;

            for (let i = 0; i < dailyData.length - 1; i++) {
                const current = dailyData[i];
                const next = dailyData[i + 1];
                const timeDiff = (next.timestamp - current.timestamp) / 1000 / 60;

                if (current.speed <= 1) {
                    totalStoppedTime += timeDiff;
                    if (!isStopped) {
                        isStopped = true;
                        stopStartTime = new Date(current.timestamp);
                        stopStartLocation = current.location;
                        stopStartLatLng = [current.lat, current.lon];
                    }
                } else {
                    const segmentDistance = haversineDistance(current.lat, current.lon, next.lat, next.lon);
                    totalDistance += segmentDistance;
                    accumulatedDistance += segmentDistance;
                    totalMovingTime += timeDiff;

                    if (isStopped) {
                        isStopped = false;
                        const stopEndTime = new Date(current.timestamp);
                        const durationMinutes = (stopEndTime - stopStartTime) / 1000 / 60;
                        if (durationMinutes > 1) {
                            stopCount++;
                            stops.push({
                                lat: stopStartLatLng[0], 
                                lon: stopStartLatLng[1], 
                                date: current.date, 
                                time: current.time, 
                                duration: durationMinutes, 
                                location: stopStartLocation,
                                number: stopCount,
                                isLongStop: durationMinutes >= LONG_STOP_THRESHOLD
                            });
                        }
                    }
                }

                if (current.speed > SPEED_LIMIT) {
                    excessiveSpeedCount++;
                    eventsContent += `<li class="text-red-500">⚠ <strong>Exceso de velocidad</strong> (${current.speed} km/h) a las ${current.time} en ${current.location}</li>`;
                }

                const speedChange = next.speed - current.speed;
                if (timeDiff > 0) {
                    const speedChangePerMinute = speedChange / timeDiff;
                    if (speedChangePerMinute > ACCELERATION_THRESHOLD) {
                        harshAccelerationCount++;
                        eventsContent += `<li class="text-red-500">⚠ <strong>Aceleración brusca</strong> (cambio de ${speedChange.toFixed(2)} km/h) a las ${current.time}</li>`;
                    } else if (speedChangePerMinute < DECELERATION_THRESHOLD) {
                        harshBrakingCount++;
                        eventsContent += `<li class="text-red-500">⚠ <strong>Frenado brusco</strong> (cambio de ${speedChange.toFixed(2)} km/h) a las ${current.time}</li>`;
                    }
                }
                
                speedData.push({ x: current.timestamp, y: current.speed, location: current.location, date: current.date, time: current.time });
                distanceData.push({ x: next.timestamp, y: accumulatedDistance, date: next.date, time: next.time });
            }
            
            if (isStopped) {
                const lastPoint = dailyData[dailyData.length - 1];
                const stopEndTime = new Date(lastPoint.timestamp);
                const durationMinutes = (stopEndTime - stopStartTime) / 1000 / 60;
                if (durationMinutes > 1) {
                    stopCount++;
                    stops.push({ 
                        lat: stopStartLatLng[0], 
                        lon: stopStartLatLng[1], 
                        date: lastPoint.date, 
                        time: lastPoint.time, 
                        duration: durationMinutes, 
                        location: stopStartLocation,
                        number: stopCount,
                        isLongStop: durationMinutes >= LONG_STOP_THRESHOLD
                    });
                }
            }

            if (excessiveSpeedCount > 0 || harshAccelerationCount > 0 || harshBrakingCount > 0) {
                eventsContent += `</ul></div>`;
            } else {
                eventsContent += `<li class="text-green-500">✅ Sin eventos de riesgo detectados.</li></ul></div>`;
            }

            grandTotalDistance += totalDistance;
            grandTotalOperatingTime += totalMovingTime;
            grandTotalStoppedTime += totalStoppedTime;

            const avgSpeed = totalMovingTime > 0 ? (totalDistance / (totalMovingTime / 60)) : 0;

            summaryTableContent += `
                <tr class="hover:bg-gray-100 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${grandTotalDistance.toFixed(2)} km</td>
                    <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${avgSpeed.toFixed(2)} km/h</td>
                    <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${formatTime(grandTotalStoppedTime)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${excessiveSpeedCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${harshAccelerationCount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${harshBrakingCount}</td>
                </tr>
            `;
        }
        
        const { gallons, cost } = calculateFuelAndCost(grandTotalDistance, vehicleType);
        const totalLiters = gallons * LITERS_PER_GALLON;

        const firstPoint = parsedData[0];
        const lastPoint = parsedData[parsedData.length - 1];
        
        const grandTotalTripTime = grandTotalOperatingTime + grandTotalStoppedTime;

        document.getElementById('summary-content').innerHTML = `
            <div class="text-center mb-8 p-6 bg-blue-100 rounded-lg border border-blue-200 shadow-md">
                <h2 class="text-xl font-extrabold text-blue-800 mb-2">Resumen General</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 text-left">
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Recorrido Total</p>
                        <p class="text-xl font-extrabold text-blue-600">${grandTotalDistance.toFixed(2)} km</p>
                    </div>
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Tiempo en Operación</p>
                        <p class="text-xl font-extrabold text-blue-600">${formatTime(grandTotalOperatingTime)}</p>
                    </div>
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Tiempo Detenido</p>
                        <p class="text-xl font-extrabold text-blue-600">${formatTime(grandTotalStoppedTime)}</p>
                    </div>
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Galones Consumidos</p>
                        <p class="text-xl font-extrabold text-blue-600">${gallons.toFixed(2)} gal</p>
                    </div>
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Litros Consumidos</p>
                        <p class="text-xl font-extrabold text-blue-600">${totalLiters.toFixed(2)} l</p>
                    </div>
                    <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                        <p class="text-xs font-semibold text-blue-900">Costo Total</p>
                        <p class="text-xl font-extrabold text-blue-600">S/. ${cost.toFixed(2)}</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-8">
                <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Resumen por Día</h2>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="summary-table min-w-full divide-y divide-gray-200 bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dist.</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vel. Prom.</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Det.</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Excesos</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acelerones</th>
                                <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frenadas</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${summaryTableContent}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        document.getElementById('events-content').innerHTML = `
            <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                ${eventsContent}
            </div>
        `;

        setTimeout(() => {
            if (allLatLngs.length > 0) {
              renderMap(allLatLngs, firstPoint, lastPoint);
              renderStopsOnMap(stops);
            }
            
            if (speedData.length > 0 && distanceData.length > 0) {
              renderCharts(speedData, distanceData);
            }
        }, 0);
    }

    function renderMap(latLngs, firstPoint, lastPoint) {
        if (mapInstance) {
            mapInstance.remove();
        }
        
        mapInstance = L.map('map').setView(latLngs[0], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mapInstance);
        
        const polyline = L.polyline(latLngs, {color: 'blue'}).addTo(mapInstance);
        mapInstance.fitBounds(polyline.getBounds());
        
        const startIconCustom = L.divIcon({
            className: 'start-icon-custom',
            html: 'A',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const endIconCustom = L.divIcon({
            className: 'end-icon-custom',
            html: 'B',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        const startPopupContent = `
            <div class="font-bold">Inicio del Recorrido</div>
            <div>Fecha: ${firstPoint.date}</div>
            <div>Hora: ${firstPoint.time}</div>
            <div>Ubicación: ${firstPoint.location}</div>
            <div>Coordenadas: ${firstPoint.lat.toFixed(6)}, ${firstPoint.lon.toFixed(6)}</div>
        `;

        const endPopupContent = `
            <div class="font-bold">Fin del Recorrido</div>
            <div>Fecha: ${lastPoint.date}</div>
            <div>Hora: ${lastPoint.time}</div>
            <div>Ubicación: ${lastPoint.location}</div>
            <div>Coordenadas: ${lastPoint.lat.toFixed(6)}, ${lastPoint.lon.toFixed(6)}</div>
        `;

        L.marker([firstPoint.lat, firstPoint.lon], {icon: startIconCustom}).addTo(mapInstance)
            .bindPopup(startPopupContent);
        L.marker([lastPoint.lat, lastPoint.lon], {icon: endIconCustom}).addTo(mapInstance)
            .bindPopup(endPopupContent);
    }
    
    function renderStopsOnMap(stops) {
        if (!mapInstance) return;

        stops.forEach(stop => {
            const iconClass = stop.isLongStop ? 'long-stop-icon' : 'stop-icon';
            const iconSize = stop.isLongStop ? [32, 32] : [24, 24];
            const iconAnchor = stop.isLongStop ? [16, 16] : [12, 12];
            
            const stopIcon = L.divIcon({
                className: iconClass,
                html: stop.number,
                iconSize: iconSize,
                iconAnchor: iconAnchor
            });

            const popupContent = `
                <div class="font-bold">Parada #${stop.number}</div>
                <div>Fecha: ${stop.date}</div>
                <div>Hora: ${stop.time}</div>
                <div>Lugar: ${stop.location}</div>
                <div>Duración: ${formatStopDuration(stop.duration)}</div>
                <div>Coordenadas: ${stop.lat.toFixed(6)}, ${stop.lon.toFixed(6)}</div>
            `;
            L.marker([stop.lat, stop.lon], {icon: stopIcon}).addTo(mapInstance)
                .bindPopup(popupContent);
        });
    }

    function renderCharts(speedData, distanceData) {
        const speedCtx = document.getElementById('speedChart').getContext('2d');
        const distanceCtx = document.getElementById('distanceChart').getContext('2d');
        
        if (window.speedChartInstance) window.speedChartInstance.destroy();
        if (window.distanceChartInstance) window.distanceChartInstance.destroy();

        const speedDataWithHighlights = speedData.map(point => ({
            ...point,
            pointBackgroundColor: point.y > SPEED_LIMIT ? 'red' : '#1d4ed8',
            pointRadius: point.y > SPEED_LIMIT ? 5 : 0
        }));

        window.speedChartInstance = new Chart(speedCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Velocidad (km/h)',
                    data: speedDataWithHighlights,
                    borderColor: '#1d4ed8',
                    backgroundColor: 'rgba(29, 78, 216, 0.1)',
                    tension: 0.1,
                    pointHoverRadius: 7,
                    pointHoverBackgroundColor: 'red',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                        },
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Velocidad (km/h)'
                        }
                    }
                },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: SPEED_LIMIT,
                                yMax: SPEED_LIMIT,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    content: 'Límite de velocidad',
                                    enabled: true,
                                    position: 'start',
                                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                    color: 'white'
                                }
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                // Muestra el título solo una vez por cada punto para evitar la repetición.
                                const point = context[0].raw;
                                return `Fecha: ${point.date}, Hora: ${point.time}`;
                            },
                            label: function(context) {
                                const point = context.raw;
                                return [
                                    `Velocidad: ${point.y.toFixed(2)} km/h`,
                                    `Ubicación: ${point.location}`,
                                ];
                            }
                        }
                    }
                }
            }
        });

        window.distanceChartInstance = new Chart(distanceCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Distancia Acumulada (km)',
                    data: distanceData,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    pointRadius: 5,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                        },
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Distancia (km)'
                        }
                    }
                },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    }
                }
            }
        });
    }

    function resetZoom() {
        if (window.speedChartInstance) {
            window.speedChartInstance.resetZoom();
        }
        if (window.distanceChartInstance) {
            window.distanceChartInstance.resetZoom();
        }
    }

    function exportToCSV() {
        const table = document.querySelector('.summary-table');
        if (!table) {
            const resultsDiv = document.getElementById('results');
            messageText.innerText = "No hay datos para exportar. Por favor, realiza un análisis primero.";
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        let csv = [];
        const rows = table.querySelectorAll('tr');

        for (const row of rows) {
            const cols = row.querySelectorAll('th, td');
            const rowData = [];
            for (const col of cols) {
                rowData.push(col.innerText);
            }
            csv.push(rowData.join(';'));
        }

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'analisis_ruta_resumen.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const results = document.getElementById('results');
        if (!results.querySelector('.summary-table')) {
            messageText.innerText = "No hay datos para exportar. Por favor, realiza un análisis primero.";
            messageBox.style.display = 'block';
            messageBox.classList.add('error');
            return;
        }

        const loader = document.createElement('div');
        loader.innerText = 'Generando PDF...';
        loader.className = 'fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center text-xl font-bold z-50';
        document.body.appendChild(loader);

        html2canvas(results, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('analisis_ruta.pdf');
            document.body.removeChild(loader);
        });
    }
</script>

</body>
</html>




